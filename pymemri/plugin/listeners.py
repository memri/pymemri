# AUTOGENERATED! DO NOT EDIT! File to edit: nbs/plugin.listeners.ipynb (unless otherwise specified).

__all__ = ['status_listener', 'force_exit_callback', 'get_abort_plugin_listener']

# Cell

import time
import os
import signal
from threading import Thread

# Cell
def status_listener(client, run_id, status, callback, interval=5, verbose=False):
    """
    Listens to status field of plugin, and executes callback when run.status == status.
    """
    if verbose:
        print(f"Listening for status='{status}' on Item {run_id}", flush=True)
    while True:
        time.sleep(interval)
        try:
            run = client.get(run_id)
            if verbose:
                print("run status:", run.status, flush=True)
            if run.status == status:
                callback()
        except Exception as e:
            print(f"Could not get run in status listener: {e}")

# Cell
def force_exit_callback():
    print("Status aborted, killing plugin...", flush=True)
    os._exit(os.EX_OK)
    # NOTE os.kill does not work in Docker for some reason.
    # pid = os.getpid()
    # os.kill(pid, signal.SIGTERM)

def get_abort_plugin_listener(client, run_id, **kwargs):
    listener = Thread(
        target=status_listener,
        args=(client, run_id, "aborted", force_exit_callback),
        kwargs=kwargs
    )
    listener.start()
    return listener