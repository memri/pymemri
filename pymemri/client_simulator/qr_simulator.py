
import flask
from flask import render_template
from pymemri.pod.client import PodClient
from pymemri.plugin.pluginbase import POD_TARGET_ITEM_ENV
import os
import json
import traceback
from fastscript import call_parse, Param

app = flask.Flask(__name__, template_folder='template')
app.config["DEBUG"] = True


# def get_run_from_env(pod_client):
#     try:
#         env = os.environ
#         run_item_json = json.loads(str(env[POD_TARGET_ITEM_ENV]))
#         run_id = run_item_json["id"]
#         run = pod_client.get(run_id)
#         return run
#     except Exception as e:
#         traceback.print_exc()
#         return None

@app.route('/qr')
def index():
    # global qr_code_data
    # qr_code_data ="data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iVVRGLTgiPz4KPHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIGhlaWdodD0iMjcwIiB3aWR0aD0iMjcwIiBjbGFzcz0icHlxcmNvZGUiPjxwYXRoIGZpbGw9InJnYmEoMCwwLDAsMC4wKSIgZD0iTTAgMGgyNzB2MjcwaC0yNzB6Ii8+PHBhdGggdHJhbnNmb3JtPSJzY2FsZSg2KSIgc3Ryb2tlPSIjMTIyRTMxIiBjbGFzcz0icHlxcmxpbmUiIGQ9Ik0wIDAuNWg3bTUgMGgybTMgMGgxbTQgMGgybTEgMGgxbTIgMGg1bTMgMGgxbTEgMGg3bS00NSAxaDFtNSAwaDFtMSAwaDFtMyAwaDNtMSAwaDFtMSAwaDJtNCAwaDFtNyAwaDJtMSAwaDFtMiAwaDFtNSAwaDFtLTQ1IDFoMW0xIDBoM20xIDBoMW0yIDBoMm0yIDBoMm00IDBoMW0xIDBoMW0xIDBoMW0xIDBoMW0yIDBoMW0xIDBoMm0xIDBoMW0xIDBoMW0yIDBoMW0xIDBoM20xIDBoMW0tNDUgMWgxbTEgMGgzbTEgMGgxbTEgMGgxbTQgMGgxbTEgMGgxbTEgMGgzbTEgMGgybTEgMGgxbTUgMGgybTMgMGgybTEgMGgxbTEgMGgzbTEgMGgxbS00NSAxaDFtMSAwaDNtMSAwaDFtMiAwaDRtMSAwaDFtMyAwaDhtMSAwaDJtMSAwaDNtMSAwaDNtMSAwaDFtMSAwaDNtMSAwaDFtLTQ1IDFoMW01IDBoMW0xIDBoMW0xIDBoMW0zIDBoM20zIDBoMW0zIDBoMW0xIDBoNG04IDBoMW01IDBoMW0tNDUgMWg3bTEgMGgxbTEgMGgxbTEgMGgxbTEgMGgxbTEgMGgxbTEgMGgxbTEgMGgxbTEgMGgxbTEgMGgxbTEgMGgxbTEgMGgxbTEgMGgxbTEgMGgxbTEgMGgxbTEgMGgxbTEgMGg3bS0zMyAxaDJtMSAwaDFtMSAwaDJtMSAwaDFtMyAwaDJtMSAwaDFtMSAwaDJtMSAwaDVtLTM3IDFoNW0xIDBoM20xIDBoNG0xIDBoMm0xIDBoMW0xIDBoNm0zIDBoMW0xIDBoMW0yIDBoMW0yIDBoMW0xIDBoMW0xIDBoMW0xIDBoMW0tNDMgMWgxbTIgMGgxbTIgMGgxbTEgMGgzbTEgMGgybTIgMGgxbTEgMGgxbTMgMGgxbTQgMGgzbTUgMGgxbTQgMGgxbTIgMGgxbS00NSAxaDNtMSAwaDRtNSAwaDFtMyAwaDRtMyAwaDVtMSAwaDJtMSAwaDFtMSAwaDVtMSAwaDJtLTM5IDFoMW0zIDBoNW0xIDBoMW0xIDBoMW0xIDBoMm0xIDBoMW0xIDBoMW0xIDBoM20yIDBoM20yIDBoMW0xIDBoMW0xIDBoMW0yIDBoMW0tNDMgMWgybTIgMGgxbTEgMGgxbTUgMGgybTEgMGgxbTEgMGg0bTEgMGgybTYgMGgxbTIgMGg1bTMgMGgxbTIgMGgxbS00NCAxaDFtMSAwaDFtMyAwaDFtMSAwaDNtMSAwaDFtNCAwaDFtMyAwaDFtMSAwaDJtNCAwaDJtMyAwaDNtMyAwaDFtMSAwaDJtLTQ0IDFoMW00IDBoM20yIDBoMW0xIDBoMW0xIDBoMW0xIDBoMm0xIDBoMm0xIDBoMm0yIDBoMm01IDBoMm0xIDBoMm0xIDBoMm0tNDIgMWgxbTEgMGgxbTEgMGgxbTIgMGg0bTEgMGgzbTQgMGgxbTEgMGgxbTEgMGgybTIgMGgybTEgMGgzbTIgMGgybTIgMGgxbTEgMGg0bS00NSAxaDFtMiAwaDRtMSAwaDFtMSAwaDRtMSAwaDVtMSAwaDNtMSAwaDNtMSAwaDFtNCAwaDFtNyAwaDJtLTQ0IDFoNG0xIDBoMW0xIDBoMW0xIDBoMW0xIDBoMW0xIDBoMW00IDBoNG0zIDBoMW0yIDBoNG0zIDBoM20xIDBoMW0xIDBoMW0tNDIgMWgybTEgMGgxbTEgMGgzbTQgMGgxbTEgMGgxbTEgMGgybTEgMGgxbTEgMGg0bTQgMGgxbTMgMGgxbTIgMGgybTIgMGg0bS00NCAxaDJtMSAwaDFtMSAwaDFtMSAwaDFtMSAwaDJtMSAwaDFtMyAwaDFtMSAwaDJtNCAwaDFtMSAwaDNtMiAwaDJtMyAwaDFtMiAwaDFtMiAwaDFtLTM5IDFoN20xIDBoMm0xIDBoMW0xIDBoMm0xIDBoN20yIDBoMW00IDBoN20tNDAgMWgybTEgMGgxbTMgMGgybTMgMGgybTIgMGgybTEgMGgxbTMgMGgybTEgMGgxbTEgMGg0bTIgMGgybTMgMGgxbTIgMGgybS00NCAxaDRtMSAwaDFtMSAwaDJtMSAwaDNtMyAwaDFtMSAwaDJtMSAwaDFtMSAwaDJtMyAwaDFtMSAwaDNtMSAwaDJtMSAwaDFtMSAwaDRtLTQwIDFoMW0zIDBoM200IDBoNm0zIDBoMW0xIDBoMW0xIDBoMW0xIDBoM20xIDBoMW0xIDBoMW0zIDBoNG0tNDAgMWgxMG0xIDBoNG0xIDBoNW0yIDBoMW0zIDBoMW0zIDBoNm0tNDEgMWgxbTIgMGgxbTEgMGgxbTEgMGg0bTEgMGgybTEgMGgxbTQgMGgybTMgMGgxbTEgMGg0bTUgMGgxbTQgMGgxbS00MSAxaDFtMiAwaDRtMyAwaDNtNCAwaDFtMiAwaDJtMSAwaDRtMSAwaDFtMSAwaDJtMSAwaDFtMiAwaDFtMiAwaDFtMSAwaDJtLTQzIDFoMm0xIDBoMW0zIDBoMm0yIDBoMW0zIDBoNG0yIDBoM20zIDBoM20yIDBoMW0zIDBoMW0xIDBoMW0xIDBoM20tNDAgMWg0bTIgMGgybTEgMGgxbTIgMGgzbTYgMGgybTIgMGgxbTEgMGgxbTcgMGgybTEgMGgxbS00MyAxaDFtMiAwaDJtMyAwaDNtMSAwaDFtNCAwaDRtMiAwaDNtMSAwaDRtMSAwaDFtNSAwaDFtNCAwaDJtLTQ1IDFoMW0xIDBoMW0xIDBoMW0xIDBoNm00IDBoMW0zIDBoMm00IDBoMW00IDBoMW0xIDBoMm0yIDBoMW0yIDBoMW0tNDEgMWg1bTUgMGg0bTEgMGgxbTEgMGgxbTUgMGgzbTMgMGgybTIgMGgxbTEgMGgxbTIgMGgybTIgMGgybS00MyAxaDFtMyAwaDNtMiAwaDFtMSAwaDFtMiAwaDFtMSAwaDNtNSAwaDJtMiAwaDNtMiAwaDFtMSAwaDFtMSAwaDFtMSAwaDFtMiAwaDJtLTQ0IDFoMW0xIDBoMW02IDBoMm0xIDBoMm0zIDBoM20xIDBoMW0xIDBoMm0xIDBoNW0zIDBoMm0yIDBoMW0zIDBoMm0tNDEgMWgxbTEgMGgybTEgMGgxbTMgMGgxbTEgMGgxbTQgMGg0bTEgMGg2bTEgMGgxbTQgMGgxbTEgMGgybS00MCAxaDRtMiAwaDJtMiAwaDFtMSAwaDFtMSAwaDJtMSAwaDRtMiAwaDJtMiAwaDFtMiAwaDJtMiAwaDhtLTQzIDFoMW0yIDBoMm0xIDBoMm0yIDBoMm01IDBoMm0xIDBoNW00IDBoMm0yIDBoMm0xIDBoNW0xIDBoMW0xIDBoMW0tMzcgMWgxbTEgMGgxbTEgMGgzbTUgMGgxbTMgMGgybTEgMGgybTEgMGgxbTUgMGgxbTMgMGgxbTMgMGgxbS00NSAxaDdtMSAwaDJtMSAwaDFtMSAwaDNtMyAwaDJtMSAwaDFtMSAwaDFtMiAwaDFtMyAwaDFtMiAwaDNtMSAwaDFtMSAwaDJtMSAwaDFtLTQ0IDFoMW01IDBoMW0yIDBoMm0xIDBoMm0xIDBoNm0zIDBoMm0yIDBoNG0xIDBoMW0xIDBoMm0zIDBoM20xIDBoMW0tNDUgMWgxbTEgMGgzbTEgMGgxbTEgMGgxbTEgMGgxbTEgMGgxbTIgMGgxbTEgMGgybTEgMGg1bTYgMGgxbTIgMGgxbTEgMGg2bTEgMGgxbS00NCAxaDFtMSAwaDNtMSAwaDFtMSAwaDJtMiAwaDNtMyAwaDFtNiAwaDFtMiAwaDFtMSAwaDJtMyAwaDFtMSAwaDFtMSAwaDVtLTQ0IDFoMW0xIDBoM20xIDBoMW0xIDBoNm01IDBoMW0zIDBoNW0xIDBoMW0xIDBoMW00IDBoMW0xIDBoMW0yIDBoMm0xIDBoMW0tNDUgMWgxbTUgMGgxbTEgMGgybTEgMGgxbTEgMGgxbTEgMGgxbTMgMGgybTIgMGgxbTEgMGgybTEgMGgxbTMgMGg2bTEgMGgxbTEgMGgybS00MyAxaDdtMSAwaDNtMiAwaDFtMiAwaDFtMSAwaDJtMiAwaDZtMSAwaDFtMSAwaDFtMSAwaDFtMiAwaDFtMiAwaDJtMiAwaDEiLz48L3N2Zz4K"
    global pod_client
    global _run_id
    # run = get_run_from_env(pod_client)
    try:
        run = pod_client.get(_run_id)
        account = run.account[0]
        qr_code_data = account.code
    except Exception as e:
        traceback.print_exc()
        qr_code_data = None
    
    return render_template('images.html', chart_output=qr_code_data)

pod_client = PodClient.from_local_keys()
_run_id = None

@call_parse
def run_qr_simulator(run_id:Param("Run id, we attach qr code to run.account.code", str)=None):
    print("GO TO http://localhost:8000/qr and scan the code")
    assert run_id is not None
    global _run_id
    _run_id = run_id
    app.run(host='0.0.0.0', port=8000)


# if __name__ == "__main__":
#     run()


